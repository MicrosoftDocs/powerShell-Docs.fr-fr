---
ms.date: 06/11/2020
keywords: powershell,applet de commande
title: Considérations de sécurité concernant l’accès distant à PowerShell avec WinRM
description: Ce document couvre les questions de sécurité, les recommandations et les bonnes pratiques lors de l’utilisation de la communication à distance PowerShell.
ms.openlocfilehash: 48167bd297905883b3d75caf9a07d06e6a9fc467
ms.sourcegitcommit: ba7315a496986451cfc1296b659d73ea2373d3f0
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/10/2020
ms.locfileid: "92501471"
---
# <a name="security-considerations-for-powershell-remoting-using-winrm"></a><span data-ttu-id="de92d-104">Considérations de sécurité concernant l’accès distant à PowerShell avec WinRM</span><span class="sxs-lookup"><span data-stu-id="de92d-104">Security Considerations for PowerShell Remoting using WinRM</span></span>

<span data-ttu-id="de92d-105">La communication à distance PowerShell est la méthode recommandée pour gérer les systèmes Windows.</span><span class="sxs-lookup"><span data-stu-id="de92d-105">PowerShell Remoting is the recommended way to manage Windows systems.</span></span> <span data-ttu-id="de92d-106">La communication à distance PowerShell est activée par défaut dans Windows Server 2012 R2.</span><span class="sxs-lookup"><span data-stu-id="de92d-106">PowerShell Remoting is enabled by default in Windows Server 2012 R2.</span></span> <span data-ttu-id="de92d-107">Ce document couvre les questions de sécurité, les recommandations et les bonnes pratiques lors de l’utilisation de la communication à distance PowerShell.</span><span class="sxs-lookup"><span data-stu-id="de92d-107">This document covers security concerns, recommendations, and best practices when using PowerShell Remoting.</span></span>

## <a name="what-is-powershell-remoting"></a><span data-ttu-id="de92d-108">Présentation de la communication à distance PowerShell</span><span class="sxs-lookup"><span data-stu-id="de92d-108">What is PowerShell Remoting?</span></span>

<span data-ttu-id="de92d-109">La communication à distance Powershell utilise la [Gestion à distance de Windows (WinRM)](/windows/win32/winrm/portal), l’implémentation par Microsoft du protocole [Gestion des services Web (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf), pour permettre aux utilisateurs d’exécuter des commandes PowerShell sur des ordinateurs distants.</span><span class="sxs-lookup"><span data-stu-id="de92d-109">PowerShell Remoting uses [Windows Remote Management (WinRM)](/windows/win32/winrm/portal), which is the Microsoft implementation of the [Web Services for Management (WS-Management)](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf) protocol, to allow users to run PowerShell commands on remote computers.</span></span> <span data-ttu-id="de92d-110">Pour plus d’informations sur l’utilisation de la communication à distance PowerShell, voir [Exécution de commandes à distance](running-remote-commands.md).</span><span class="sxs-lookup"><span data-stu-id="de92d-110">You can find more information about using PowerShell Remoting at [Running Remote Commands](running-remote-commands.md).</span></span>

<span data-ttu-id="de92d-111">La communication à distance PowerShell n’est pas identique à l’utilisation du paramètre **ComputerName** d’une applet de commande pour l’exécuter sur un ordinateur distant, qui utilise l’appel de procédure distante (RPC) en tant que protocole sous-jacent.</span><span class="sxs-lookup"><span data-stu-id="de92d-111">PowerShell Remoting is not the same as using the **ComputerName** parameter of a cmdlet to run it on a remote computer, which uses Remote Procedure Call (RPC) as its underlying protocol.</span></span>

## <a name="powershell-remoting-default-settings"></a><span data-ttu-id="de92d-112">Paramètres par défaut de la communication à distance PowerShell</span><span class="sxs-lookup"><span data-stu-id="de92d-112">PowerShell Remoting default settings</span></span>

<span data-ttu-id="de92d-113">La communication à distance PowerShell et WinRM écoutent sur les ports suivants :</span><span class="sxs-lookup"><span data-stu-id="de92d-113">PowerShell Remoting (and WinRM) listen on the following ports:</span></span>

- <span data-ttu-id="de92d-114">HTTP : 5985</span><span class="sxs-lookup"><span data-stu-id="de92d-114">HTTP: 5985</span></span>
- <span data-ttu-id="de92d-115">HTTPS : 5986</span><span class="sxs-lookup"><span data-stu-id="de92d-115">HTTPS: 5986</span></span>

<span data-ttu-id="de92d-116">Par défaut, la communication à distance PowerShell autorise uniquement les connexions des membres du groupe de l’administrateur.</span><span class="sxs-lookup"><span data-stu-id="de92d-116">By default, PowerShell Remoting only allows connections from members of the Administrators group.</span></span>
<span data-ttu-id="de92d-117">Les sessions étant lancées dans le contexte de l’utilisateur, tous les contrôles d’accès au système d’exploitation appliqués à des utilisateurs et des groupes continuent de leur être appliqués pendant la connexion via la communication à distance PowerShell.</span><span class="sxs-lookup"><span data-stu-id="de92d-117">Sessions are launched under the user's context, so all operating system access controls applied to individual users and groups continue to apply to them while connected over PowerShell Remoting.</span></span>

<span data-ttu-id="de92d-118">Sur les réseaux privés, la règle de Pare-feu Windows par défaut pour la communication à distance PowerShell accepte toutes les connexions.</span><span class="sxs-lookup"><span data-stu-id="de92d-118">On private networks, the default Windows Firewall rule for PowerShell Remoting accepts all connections.</span></span> <span data-ttu-id="de92d-119">Sur les réseaux publics, la règle de Pare-feu Windows par défaut autorise les connexions de communication à distance PowerShell uniquement sur le même sous-réseau.</span><span class="sxs-lookup"><span data-stu-id="de92d-119">On public networks, the default Windows Firewall rule allows PowerShell Remoting connections only from within the same subnet.</span></span> <span data-ttu-id="de92d-120">Vous devez modifier explicitement cette règle pour ouvrir la communication à distance PowerShell à toutes les connexions sur un réseau public.</span><span class="sxs-lookup"><span data-stu-id="de92d-120">You have to explicitly change that rule to open PowerShell Remoting to all connections on a public network.</span></span>

> [!Warning]
> <span data-ttu-id="de92d-121">la règle de pare-feu pour les réseaux publics est destinée à protéger l’ordinateur contre les tentatives de connexions externes potentiellement malveillantes.</span><span class="sxs-lookup"><span data-stu-id="de92d-121">The firewall rule for public networks is meant to protect the computer from potentially malicious external connection attempts.</span></span> <span data-ttu-id="de92d-122">Soyez prudent lors de la suppression de cette règle.</span><span class="sxs-lookup"><span data-stu-id="de92d-122">Use caution when removing this rule.</span></span>

## <a name="process-isolation"></a><span data-ttu-id="de92d-123">Isolation des processus</span><span class="sxs-lookup"><span data-stu-id="de92d-123">Process isolation</span></span>

<span data-ttu-id="de92d-124">La communication à distance PowerShell utilise WinRM pour la communication entre les ordinateurs.</span><span class="sxs-lookup"><span data-stu-id="de92d-124">PowerShell Remoting uses WinRM for communication between computers.</span></span> <span data-ttu-id="de92d-125">WinRM s’exécute comme service sous le compte de service réseau et génère des processus isolés exécutés comme comptes d’utilisateur pour héberger les instances de PowerShell.</span><span class="sxs-lookup"><span data-stu-id="de92d-125">WinRM runs as a service under the Network Service account, and spawns isolated processes running as user accounts to host PowerShell instances.</span></span> <span data-ttu-id="de92d-126">Une instance de PowerShell exécutée comme un utilisateur n’a pas accès à un processus utilisant une instance de PowerShell exécutée comme autre utilisateur.</span><span class="sxs-lookup"><span data-stu-id="de92d-126">An instance of PowerShell running as one user has no access to a process running an instance of PowerShell as another user.</span></span>

## <a name="event-logs-generated-by-powershell-remoting"></a><span data-ttu-id="de92d-127">Journaux des événements générés par la communication à distance PowerShell</span><span class="sxs-lookup"><span data-stu-id="de92d-127">Event logs generated by PowerShell Remoting</span></span>

<span data-ttu-id="de92d-128">FireEye a fourni un bon résumé des journaux des événements et autres preuves de sécurité générés par les sessions de communication à distance PowerShell, disponible sur [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span><span class="sxs-lookup"><span data-stu-id="de92d-128">FireEye has provided a good summary of the event logs and other security evidence generated by PowerShell Remoting sessions, available at [Investigating PowerShell Attacks](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf).</span></span>

## <a name="encryption-and-transport-protocols"></a><span data-ttu-id="de92d-129">Protocoles de transport et chiffrement</span><span class="sxs-lookup"><span data-stu-id="de92d-129">Encryption and transport protocols</span></span>

<span data-ttu-id="de92d-130">Il est utile de prendre en compte la connexion de communication à distance PowerShell sous deux angles : l’authentification initiale et les communications en cours.</span><span class="sxs-lookup"><span data-stu-id="de92d-130">It is helpful to consider the security of a PowerShell Remoting connection from two perspectives: initial authentication, and ongoing communication.</span></span>

<span data-ttu-id="de92d-131">Quel que soit le protocole de transport utilisé (HTTP ou HTTPS), WinRM chiffre toujours l’intégralité des communications à distance PowerShell après l’authentification initiale.</span><span class="sxs-lookup"><span data-stu-id="de92d-131">Regardless of the transport protocol used (HTTP or HTTPS), WinRM always encrypts all PowerShell remoting communication after initial authentication.</span></span>

### <a name="initial-authentication"></a><span data-ttu-id="de92d-132">Authentification initiale</span><span class="sxs-lookup"><span data-stu-id="de92d-132">Initial authentication</span></span>

<span data-ttu-id="de92d-133">L’authentification confirme l’identité du client auprès du serveur et, idéalement, du serveur auprès du client.</span><span class="sxs-lookup"><span data-stu-id="de92d-133">Authentication confirms the identity of the client to the server - and ideally - the server to the client.</span></span>

<span data-ttu-id="de92d-134">Quand un client se connecte à un serveur de domaine à l’aide de son nom d’ordinateur, le protocole d’authentification par défaut est [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span><span class="sxs-lookup"><span data-stu-id="de92d-134">When a client connects to a domain server using its computer name, the default authentication protocol is [Kerberos](/windows/win32/secauthn/microsoft-kerberos).</span></span> <span data-ttu-id="de92d-135">Kerberos garantit l’identité de l’utilisateur et l’identité du serveur sans envoyer aucune sorte d’informations d’identification réutilisables.</span><span class="sxs-lookup"><span data-stu-id="de92d-135">Kerberos guarantees both the user identity and server identity without sending any sort of reusable credential.</span></span>

<span data-ttu-id="de92d-136">Quand un client se connecte à un serveur de domaine avec son adresse IP ou qu’il se connecte à un serveur de groupe de travail, l’authentification Kerberos n’est pas possible.</span><span class="sxs-lookup"><span data-stu-id="de92d-136">When a client connects to a domain server using its IP address, or connects to a workgroup server, Kerberos authentication is not possible.</span></span> <span data-ttu-id="de92d-137">Dans ce cas, la communication à distance PowerShell s’appuie sur le [protocole d’authentification NTLM](/windows/win32/secauthn/microsoft-ntlm).</span><span class="sxs-lookup"><span data-stu-id="de92d-137">In that case, PowerShell Remoting relies on the [NTLM authentication protocol](/windows/win32/secauthn/microsoft-ntlm).</span></span> <span data-ttu-id="de92d-138">Le protocole d’authentification NTLM garantit l’identité de l’utilisateur sans envoyer aucune sorte d’informations d’identification délégables.</span><span class="sxs-lookup"><span data-stu-id="de92d-138">The NTLM authentication protocol guarantees the user identity without sending any sort of delegable credential.</span></span> <span data-ttu-id="de92d-139">Pour prouver l’identité de l’utilisateur, le protocole NTLM nécessite que le client et le serveur calculent une clé de session à partir du mot de passe de l’utilisateur sans jamais s’échanger le mot de passe proprement dit.</span><span class="sxs-lookup"><span data-stu-id="de92d-139">To prove user identity, the NTLM protocol requires that both the client and server compute a session key from the user's password without ever exchanging the password itself.</span></span> <span data-ttu-id="de92d-140">Le serveur ne connaissant en général pas le mot de passe de l’utilisateur, il communique avec le contrôleur de domaine qui connaît ce mot de passe et calcule la clé de session pour le serveur.</span><span class="sxs-lookup"><span data-stu-id="de92d-140">The server typically does not know the user's password, so it communicates with the domain controller, which does know the user's password and calculates the session key for the server.</span></span>

<span data-ttu-id="de92d-141">Le protocole NTLM ne garantit cependant pas l’identité du serveur.</span><span class="sxs-lookup"><span data-stu-id="de92d-141">The NTLM protocol does not, however, guarantee server identity.</span></span> <span data-ttu-id="de92d-142">Comme avec tous les protocoles qui utilisent NTLM pour l’authentification, un pirate ayant accès au compte d’un ordinateur appartenant à un domaine peut appeler le contrôleur de domaine pour calculer une clé de session NTLM et donc emprunter l’identité du serveur.</span><span class="sxs-lookup"><span data-stu-id="de92d-142">As with all protocols that use NTLM for authentication, an attacker with access to a domain-joined computer's machine account could invoke the domain controller to compute an NTLM session-key and thereby impersonate the server.</span></span>

<span data-ttu-id="de92d-143">L’authentification NTLM est désactivée par défaut, mais peut être autorisée en configurant SSL sur le serveur cible ou en configurant le paramètre WinRM TrustedHosts sur le client.</span><span class="sxs-lookup"><span data-stu-id="de92d-143">NTLM-based authentication is disabled by default, but may be permitted by either configuring SSL on the target server, or by configuring the WinRM TrustedHosts setting on the client.</span></span>

#### <a name="using-ssl-certificates-to-validate-server-identity-during-ntlm-based-connections"></a><span data-ttu-id="de92d-144">Utilisation de certificats SSL pour valider l’identité du serveur pendant les connexions NTLM</span><span class="sxs-lookup"><span data-stu-id="de92d-144">Using SSL certificates to validate server identity during NTLM-based connections</span></span>

<span data-ttu-id="de92d-145">Étant donné que le protocole d’authentification NTLM ne peut pas garantir l’identité du serveur cible (seulement qu’il connaît déjà votre mot de passe), vous pouvez configurer des serveurs cibles pour utiliser SSL pour la communication à distance PowerShell.</span><span class="sxs-lookup"><span data-stu-id="de92d-145">Since the NTLM authentication protocol cannot ensure the identity of the target server (only that it already knows your password), you can configure target servers to use SSL for PowerShell Remoting.</span></span>
<span data-ttu-id="de92d-146">L’attribution d’un certificat SSL au serveur cible (s’il est émis par une autorité de certification également approuvée par le client) active l’authentification NTLM qui garantit l’identité de l’utilisateur et l’identité du serveur.</span><span class="sxs-lookup"><span data-stu-id="de92d-146">Assigning a SSL certificate to the target server (if issued by a Certificate Authority that the client also trusts) enables NTLM-based authentication that guarantees both the user identity and server identity.</span></span>

#### <a name="ignoring-ntlm-based-server-identity-errors"></a><span data-ttu-id="de92d-147">Erreurs d’identité de serveur NTLM ignorées</span><span class="sxs-lookup"><span data-stu-id="de92d-147">Ignoring NTLM-based server identity errors</span></span>

<span data-ttu-id="de92d-148">S’il n’est pas possible de déployer un certificat SSL sur un serveur pour les connexions NTLM, vous pouvez supprimer les erreurs d’identité obtenues en ajoutant le serveur à la liste **TrustedHosts** de WinRM.</span><span class="sxs-lookup"><span data-stu-id="de92d-148">If deploying a SSL certificate to a server for NTLM connections is infeasible, you may suppress the resulting identity errors by adding the server to the WinRM **TrustedHosts** list.</span></span> <span data-ttu-id="de92d-149">Notez que l’ajout d’un nom de serveur à la liste **TrustedHosts** ne doit pas être considéré comme une garantie de fiabilité des hôtes, puisque le protocole d’authentification NTLM ne peut pas garantir que vous vous connectez réellement à l’hôte souhaité.</span><span class="sxs-lookup"><span data-stu-id="de92d-149">Please note that adding a server name to the **TrustedHosts** list should not be considered as any form of statement of the trustworthiness of the hosts themselves - as the NTLM authentication protocol cannot guarantee that you are in fact connecting to the host you are intending to connect to.</span></span> <span data-ttu-id="de92d-150">Vous devez plutôt considérer le paramètre TrustedHosts comme représentant la liste des hôtes pour lesquels vous voulez supprimer l’erreur générée par l’impossibilité de vérifier l’identité du serveur.</span><span class="sxs-lookup"><span data-stu-id="de92d-150">Instead, you should consider the TrustedHosts setting to be the list of hosts for which you wish to suppress the error generated by being unable to verify the server's identity.</span></span>

### <a name="ongoing-communication"></a><span data-ttu-id="de92d-151">Communications en cours</span><span class="sxs-lookup"><span data-stu-id="de92d-151">Ongoing Communication</span></span>

<span data-ttu-id="de92d-152">Une fois l’authentification initiale terminée, WinRM chiffre toutes les communications en cours.</span><span class="sxs-lookup"><span data-stu-id="de92d-152">Once initial authentication is complete, the WinRM encrypts the ongoing communication.</span></span> <span data-ttu-id="de92d-153">Lors de la connexion via HTTPS, le protocole TLS est utilisé pour négocier le chiffrement qui est utilisé pour le transport des données.</span><span class="sxs-lookup"><span data-stu-id="de92d-153">When connecting over HTTPS, the TLS protocol is used to negotiate the encryption used to transport data.</span></span>
<span data-ttu-id="de92d-154">Lors de la connexion via HTTP, le chiffrement au niveau du message est déterminé par le protocole utilisé lors de l’authentification initiale.</span><span class="sxs-lookup"><span data-stu-id="de92d-154">When connecting over HTTP, message-level encryption is determined by initial authentication protocol used.</span></span>

- <span data-ttu-id="de92d-155">L’authentification de base ne fournit pas de chiffrement.</span><span class="sxs-lookup"><span data-stu-id="de92d-155">Basic authentication provide no encryption.</span></span>
- <span data-ttu-id="de92d-156">L’authentification NTLM utilise un chiffrement RC4 avec une clé de 128 bits.</span><span class="sxs-lookup"><span data-stu-id="de92d-156">NTLM authentication uses an RC4 cipher with a 128-bit key.</span></span>
- <span data-ttu-id="de92d-157">Le chiffrement de l’authentification Kerberos est déterminé par le `etype` du ticket TGS.</span><span class="sxs-lookup"><span data-stu-id="de92d-157">Kerberos authentication encryption is determined by the `etype` in the TGS ticket.</span></span> <span data-ttu-id="de92d-158">Sur les systèmes modernes, il s’agit de AES-256.</span><span class="sxs-lookup"><span data-stu-id="de92d-158">This is AES-256 on modern systems.</span></span>
- <span data-ttu-id="de92d-159">Le chiffrement CredSSP utilise la suite de chiffrement TLS qui a été négociée lors de l’établissement de la liaison.</span><span class="sxs-lookup"><span data-stu-id="de92d-159">CredSSP encryption is uses the TLS cipher suite that was negotiated in the handshake.</span></span>

## <a name="making-the-second-hop"></a><span data-ttu-id="de92d-160">Second saut</span><span class="sxs-lookup"><span data-stu-id="de92d-160">Making the second hop</span></span>

<span data-ttu-id="de92d-161">Par défaut, la communication à distance PowerShell utilise Kerberos (s’il est disponible) ou NTLM pour l’authentification.</span><span class="sxs-lookup"><span data-stu-id="de92d-161">By default, PowerShell Remoting uses Kerberos (if available) or NTLM for authentication.</span></span> <span data-ttu-id="de92d-162">Ces deux protocoles permettent de s’authentifier auprès de l’ordinateur distant sans lui envoyer d’informations d’identification.</span><span class="sxs-lookup"><span data-stu-id="de92d-162">Both of these protocols authenticate to the remote machine without sending credentials to it.</span></span> <span data-ttu-id="de92d-163">Il s’agit de la méthode la plus sûre pour s’authentifier mais, comme l’ordinateur distant ne dispose pas des informations d’identification de l’utilisateur, il ne peut pas accéder aux autres ordinateurs ni services au nom de l’utilisateur.</span><span class="sxs-lookup"><span data-stu-id="de92d-163">This is the most secure way to authenticate, but because the remote machine does not have the user's credentials, it cannot access other computers and services on the user's behalf.</span></span> <span data-ttu-id="de92d-164">Ce problème est connu sous le nom de « deuxième saut ».</span><span class="sxs-lookup"><span data-stu-id="de92d-164">This is known as the "second hop problem".</span></span>

<span data-ttu-id="de92d-165">Il existe plusieurs moyens de l’éviter.</span><span class="sxs-lookup"><span data-stu-id="de92d-165">There are several ways to avoid this problem.</span></span> <span data-ttu-id="de92d-166">Pour connaître la description de ces méthodes, ainsi que les avantages et les inconvénients de chacune, consultez [Effectuer le deuxième saut dans la communication à distance PowerShell](PS-remoting-second-hop.md).</span><span class="sxs-lookup"><span data-stu-id="de92d-166">For descriptions of these methods, and the pros and cons of each, see [Making the second hop in PowerShell Remoting](PS-remoting-second-hop.md).</span></span>

## <a name="references"></a><span data-ttu-id="de92d-167">Références</span><span class="sxs-lookup"><span data-stu-id="de92d-167">References</span></span>

- [<span data-ttu-id="de92d-168">Windows Remote Management (WinRM)</span><span class="sxs-lookup"><span data-stu-id="de92d-168">Windows Remote Management (WinRM)</span></span>](/windows/win32/winrm/portal)
- [<span data-ttu-id="de92d-169">Web Services for Management (WS-Management)</span><span class="sxs-lookup"><span data-stu-id="de92d-169">Web Services for Management (WS-Management)</span></span>](https://www.dmtf.org/sites/default/files/standards/documents/DSP0226_1.2.0.pdf)
- [<span data-ttu-id="de92d-170">Types des messages chiffrés 2.2.9.1</span><span class="sxs-lookup"><span data-stu-id="de92d-170">2.2.9.1 Encrypted Message Types</span></span>](/openspecs/windows_protocols/ms-wsmv/58421aa4-861a-4410-831a-c999f094cdb7)
- [<span data-ttu-id="de92d-171">Kerberos</span><span class="sxs-lookup"><span data-stu-id="de92d-171">Kerberos</span></span>](/windows/win32/secauthn/microsoft-kerberos)
- [<span data-ttu-id="de92d-172">Protocole d’authentification NTLM</span><span class="sxs-lookup"><span data-stu-id="de92d-172">NTLM authentication protocol</span></span>](/windows/win32/secauthn/microsoft-ntlm)
- [<span data-ttu-id="de92d-173">Investigating PowerShell Attacks</span><span class="sxs-lookup"><span data-stu-id="de92d-173">Investigating PowerShell Attacks</span></span>](https://www.fireeye.com/content/dam/fireeye-www/global/en/solutions/pdfs/wp-lazanciyan-investigating-powershell-attacks.pdf)
